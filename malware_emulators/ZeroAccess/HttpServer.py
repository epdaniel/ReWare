BASE_DIR = "C:\\ZeroAccess"
import os
import socket
import threading
import time

import SimpleHTTPServer
import SocketServer


def get_ip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        # doesn't even have to be reachable
        s.connect(('10.255.255.255', 1))
        IP = s.getsockname()[0]
    except:
        IP = '127.0.0.1'
    finally:
        s.close()
    return IP


LOCAL_IP = get_ip()  # Gets the local ip address of the PC


def serve_web(port, ip=LOCAL_IP, directory=BASE_DIR):
    handler = SimpleHTTPServer.SimpleHTTPRequestHandler
    if port is None:
        # try to find a port
        for port in xrange(8000, 9000):
            try:
                server = SocketServer.TCPServer((ip, port), handler)
                break
            except socket.error:
                pass

    else:
        server = SocketServer.TCPServer((ip, port), handler)

    def server_thread():
        print("Starting web server on http://%s:%d for directory %s" % (ip, port, directory))
        os.chdir(directory)
        server.serve_forever()

    # Start this thread in the background
    thread = threading.Thread(target=server_thread)
    thread.setDaemon(True)
    thread.start()

    time.sleep(60)
    return server, ip, port


server, ip, portOpen = serve_web(80)  # HTTP req -- local http server
